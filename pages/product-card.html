<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1A1A1A">
    <title>SimpleCalorie - Карточка продукта</title>

    <link rel="stylesheet" href="../css/variables.css">
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/product-card.css">

    <style>
        .product-header {
            position: relative;
            width: 100%;
            height: 300px;
            background: #F3F4F6;
            overflow: hidden;
        }

        .photo-gallery {
            width: 100%;
            height: 100%;
            overflow-x: auto;
            overflow-y: hidden;
            display: flex;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }

        .photo-gallery::-webkit-scrollbar {
            display: none;
        }

        .photo-slide {
            min-width: 100%;
            height: 100%;
            scroll-snap-align: start;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .photo-slide img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #F3F4F6;
        }

        .photo-arrows {
            position: absolute;
            top: 50%;
            width: 100%;
            transform: translateY(-50%);
            display: flex;
            justify-content: space-between;
            padding: 0 var(--spacing-sm);
            pointer-events: none;
            z-index: 100;
        }

        .photo-arrow {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            pointer-events: all;
        }

        .photo-arrow.visible {
            display: flex;
        }

        .close-btn {
            position: absolute;
            top: var(--spacing-md);
            left: var(--spacing-md);
            z-index: 100;
        }

        .favorite-btn {
            position: absolute;
            top: var(--spacing-md);
            right: var(--spacing-md);
            z-index: 100;
        }

        .photo-selection-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            align-items: flex-end;
            justify-content: center;
        }

        .photo-selection-popup.active {
            display: flex;
        }

        .photo-selection-content {
            background: white;
            width: 100%;
            max-width: 500px;
            border-radius: 16px 16px 0 0;
            padding: var(--spacing-md);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }

        .photo-selection-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: var(--spacing-md);
            text-align: center;
            color: var(--text-primary);
        }

        .photo-selection-buttons {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .photo-selection-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md);
            background: var(--background-secondary);
            color: var(--text-primary);
            border: none;
            border-radius: var(--radius-md);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .photo-selection-btn:active {
            background: #E5E7EB;
        }

        .photo-selection-btn svg {
            stroke: #1F2937;
        }

        .photo-selection-cancel {
            margin-top: var(--spacing-sm);
            padding: var(--spacing-md);
            background: transparent;
            color: var(--text-secondary);
            border: none;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="photo-selection-popup" id="photoSelectionPopup">
        <div class="photo-selection-content">
            <div class="photo-selection-title" data-i18n="photoSelection.title">Выберите источник</div>
            <div class="photo-selection-buttons">
                <button class="photo-selection-btn" id="selectCameraBtn">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                </button>
                <button class="photo-selection-btn" id="selectGalleryBtn">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                </button>
            </div>
            <button class="photo-selection-cancel" id="cancelPhotoSelectionBtn" data-i18n="buttons.cancel">Отмена</button>
        </div>
    </div>

    <div class="app-container">
        <header class="product-header">
          <a href="#" id="closeBtn" class="close-btn">
             <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </a>

            <div class="photo-gallery" id="photoGallery">
                <div class="photo-slide" id="slide1">
                    <img id="productPhoto" src="" alt="Продукт" style="display: none;">
                    <div id="photoPlaceholder" class="photo-placeholder">
                        <svg width="80" height="80" fill="#9CA3AF" viewBox="0 0 24 24">
                            <path d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                            <circle cx="12" cy="13" r="3" fill="#E5E7EB"/>
                        </svg>
                    </div>
                </div>
                <div class="photo-slide" id="slide2">
                      <img id="productPhoto2" src="" alt="Фото 2" style="display: none;">
                      <div id="photoPlaceholder2" class="photo-placeholder">
                          <svg width="80" height="80" fill="#9CA3AF" viewBox="0 0 24 24">
                              <path d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                              <circle cx="12" cy="13" r="3" fill="#E5E7EB"/>
                          </svg>
                      </div>
                  </div>
            </div>

            <div class="photo-arrows">
                <button class="photo-arrow" id="prevPhoto" onclick="scrollPhotos(-1)">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                </button>
                <button class="photo-arrow" id="nextPhoto" onclick="scrollPhotos(1)">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                </button>
            </div>

            <input type="file" id="photoInputCamera" accept="image/*" capture="environment" style="display: none;">
            <input type="file" id="photoInputGallery" accept="image/*" style="display: none;">
            
            <button class="photo-add" id="photoAddBtn">
                <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
            </button>

            <button class="favorite-btn" id="favoriteBtn">
                <svg class="favorite-icon" width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                </svg>
                <span class="favorite-badge">*</span>
            </button>
        </header>

        <main class="main-content">
            <div class="field-group">
                <label class="field-label" data-i18n="product.name">Название</label>
                <input type="text" class="field-input" id="productName" data-i18n-placeholder="product.namePlaceholder">
            </div>

            <div class="field-group">
                <label class="field-label" data-i18n="nutrients.calories">Калории (ккал)</label>
                <input type="number" class="field-input" id="productCalories" step="0.1">
            </div>

            <div class="field-group">
                <label class="field-label" data-i18n="nutrients.protein">Белки (г)</label>
                <input type="number" class="field-input" id="productProtein" step="0.1">
            </div>

            <div class="field-group">
                <label class="field-label" data-i18n="nutrients.fat">Жиры (г)</label>
                <input type="number" class="field-input" id="productFat" step="0.1">
            </div>

            <div class="field-group">
                <label class="field-label" data-i18n="nutrients.carbs">Углеводы (г)</label>
                <input type="number" class="field-input" id="productCarbs" step="0.1">
            </div>

            <div class="field-group">
                <label class="field-label" data-i18n="nutrients.sugar">Сахар (г)</label>
                <input type="number" class="field-input" id="productSugar" step="0.1">
            </div>

            <div class="field-group">
                <label class="field-label" data-i18n="product.portion">Порция</label>
                <div class="portion-control">
                    <input type="number" class="portion-input" id="portionNumerator" min="1" value="1">
                    <span class="portion-divider">/</span>
                    <input type="number" class="portion-input" id="portionDenominator" min="1" value="1">
                </div>
            </div>

            <div class="field-group">
                <label class="toggle-label">
                    <span data-i18n="product.unitMode">Режим единиц</span>
                    <input type="checkbox" class="toggle-input" id="unitMode">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="unit-control" id="gramsControl">
                <label class="field-label" data-i18n="product.amount">Количество</label>
                <div class="unit-input-group">
                    <input type="number" class="field-input" id="amountGrams" step="1">
                    <select class="unit-select" id="unitGrams">
                        <option value="g" selected data-i18n="units.g">г</option>
                        <option value="ml" data-i18n="units.ml">мл</option>
                    </select>
                </div>
            </div>

            <div class="unit-control disabled" id="piecesControl">
                <label class="field-label" data-i18n="product.amount">Количество</label>
                <div class="unit-input-group">
                    <input type="number" class="field-input" id="amountPieces" step="1">
                    <select class="unit-select" id="unitPieces">
                        <option value="pcs" selected data-i18n="units.pcs">шт</option>
                        <option value="slice" data-i18n="units.slice">кусок</option>
                        <option value="serving" data-i18n="units.serving">порция</option>
                    </select>
                </div>
            </div>

            <div class="field-group">
                <label class="field-label" data-i18n="product.category">Категория</label>
                <select class="field-select" id="productCategory">
                    <option value="" data-i18n="categories.none">Без категории</option>
                    <option value="breakfast" data-i18n="categories.breakfast">Завтрак</option>
                    <option value="lunch" data-i18n="categories.lunch">Обед</option>
                    <option value="dinner" data-i18n="categories.dinner">Ужин</option>
                    <option value="snack" data-i18n="categories.snack">Перекус</option>
                    <option value="drinks" data-i18n="categories.drinks">Напитки</option>
                </select>
            </div>

            <div class="field-group">
                <label class="toggle-label">
                    <span data-i18n="product.manualMode">Ручной режим (отключить автопересчёт)</span>
                    <input type="checkbox" class="toggle-input" id="manualMode">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <button class="btn btn-primary" id="saveBtn" data-i18n="buttons.save">Сохранить</button>
        </main>
    </div>

    <script src="../js/utils.js"></script>
    <script src="../js/storage.js"></script>
    <script src="../js/i18n.js"></script>

    <script>
        let currentProduct = null;
        let originalData = {};
        let productSource = null;
        let productDate = null;
        let currentPhotoIndex = 0;

        async function init() {
            await initDB();
            await initI18n();

            const params = new URLSearchParams(window.location.search);
            const productId = params.get('productId');
            productSource = params.get('source');
            productDate = params.get('date');

            if (!productId || !productSource) {
                alert('Ошибка: недостаточно данных');
                history.back();
                return;
            }

            if (productSource !== 'dish' && productSource !== 'favorites' && !productDate) {
                alert('Ошибка: недостаточно данных');
                history.back();
                return;
            }

            await loadProduct(productId);

            originalData = {
                calories: currentProduct.calories,
                protein: currentProduct.protein,
                fat: currentProduct.fat,
                carbs: currentProduct.carbs,
                sugar: currentProduct.sugar,
                amount: currentProduct.amount
            };

            fillFields();
            await updateFavoriteButton();
            updatePhotoArrows();
        }

        async function loadProduct(productId) {
            if (productSource === 'day') {
                const dayData = await getDayData(productDate);
                currentProduct = dayData.products.find(p => p.id === productId);
            } else if (productSource === 'favorites') {
                const favorites = await getAllFavorites();
                currentProduct = favorites.find(p => p.id === productId);
            } else if (productSource === 'dish') {
                const dishIngredient = localStorage.getItem('editDishIngredient');
                if (dishIngredient) {
                    currentProduct = JSON.parse(dishIngredient);
                }
            }

            if (!currentProduct) {
                alert('Продукт не найден');
                history.back();
            }
        }

        function fillFields() {
            document.getElementById('productName').value = currentProduct.name || '';
            document.getElementById('productCalories').value = currentProduct.calories || 0;
            document.getElementById('productProtein').value = currentProduct.protein || 0;
            document.getElementById('productFat').value = currentProduct.fat || 0;
            document.getElementById('productCarbs').value = currentProduct.carbs || 0;
            document.getElementById('productSugar').value = currentProduct.sugar || 0;

            const isGrams = currentProduct.unit === 'g' || currentProduct.unit === 'ml';
            document.getElementById('unitMode').checked = !isGrams;

            if (isGrams) {
                document.getElementById('amountGrams').value = currentProduct.amount || 0;
                document.getElementById('unitGrams').value = currentProduct.unit || 'g';
            } else {
                document.getElementById('amountPieces').value = currentProduct.amount || 0;
                document.getElementById('unitPieces').value = currentProduct.unit || 'pcs';
                document.getElementById('gramsControl').classList.add('disabled');
                document.getElementById('piecesControl').classList.remove('disabled');
            }

            document.getElementById('productCategory').value = currentProduct.category || '';
            document.getElementById('portionNumerator').value = currentProduct.portionNumerator || 1;
            document.getElementById('portionDenominator').value = currentProduct.portionDenominator || 1;

            if (currentProduct.photo) {
                document.getElementById('productPhoto').src = currentProduct.photo;
                document.getElementById('productPhoto').style.display = 'block';
                document.getElementById('photoPlaceholder').style.display = 'none';
            }

            if (currentProduct.photo2) {
                  document.getElementById('productPhoto2').src = currentProduct.photo2;
                  document.getElementById('productPhoto2').style.display = 'block';
                  document.getElementById('photoPlaceholder2').style.display = 'none';
              }
        }

        document.getElementById('unitMode').addEventListener('change', function() {
            if (this.checked) {
                document.getElementById('gramsControl').classList.add('disabled');
                document.getElementById('piecesControl').classList.remove('disabled');
            } else {
                document.getElementById('gramsControl').classList.remove('disabled');
                document.getElementById('piecesControl').classList.add('disabled');
            }
        });

        function recalculateNutrients() {
            const manualMode = document.getElementById('manualMode').checked;
            if (manualMode) return;

            const numerator = parseInt(document.getElementById('portionNumerator').value) || 1;
            const denominator = parseInt(document.getElementById('portionDenominator').value) || 1;
            const portionFactor = numerator / denominator;

            const newAmount = originalData.amount * portionFactor;

            if (document.getElementById('unitMode').checked) {
                document.getElementById('amountPieces').value = Math.round(newAmount);
            } else {
                document.getElementById('amountGrams').value = Math.round(newAmount);
            }

            document.getElementById('productCalories').value = (originalData.calories * portionFactor).toFixed(1);
            document.getElementById('productProtein').value = (originalData.protein * portionFactor).toFixed(1);
            document.getElementById('productFat').value = (originalData.fat * portionFactor).toFixed(1);
            document.getElementById('productCarbs').value = (originalData.carbs * portionFactor).toFixed(1);
            document.getElementById('productSugar').value = (originalData.sugar * portionFactor).toFixed(1);
        }

        document.getElementById('portionNumerator').addEventListener('change', recalculateNutrients);
        document.getElementById('portionDenominator').addEventListener('change', recalculateNutrients);
        document.getElementById('amountGrams').addEventListener('input', recalculateNutrients);
        document.getElementById('amountPieces').addEventListener('input', recalculateNutrients);

        const photoSelectionPopup = document.getElementById('photoSelectionPopup');
        const photoAddBtn = document.getElementById('photoAddBtn');
        const selectCameraBtn = document.getElementById('selectCameraBtn');
        const selectGalleryBtn = document.getElementById('selectGalleryBtn');
        const cancelPhotoSelectionBtn = document.getElementById('cancelPhotoSelectionBtn');
        const photoInputCamera = document.getElementById('photoInputCamera');
        const photoInputGallery = document.getElementById('photoInputGallery');

        photoAddBtn.addEventListener('click', function() {
            photoSelectionPopup.classList.add('active');
        });

        function closePhotoPopup() {
            photoSelectionPopup.classList.remove('active');
        }

        cancelPhotoSelectionBtn.addEventListener('click', closePhotoPopup);

        photoSelectionPopup.addEventListener('click', function(e) {
            if (e.target === photoSelectionPopup) {
                closePhotoPopup();
            }
        });

        selectCameraBtn.addEventListener('click', function() {
            photoInputCamera.click();
            closePhotoPopup();
        });

        selectGalleryBtn.addEventListener('click', function() {
            photoInputGallery.click();
            closePhotoPopup();
        });

        photoInputCamera.addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (file) {
                const base64 = await blobToBase64(file);
                updatePhoto(base64);
            }
        });

        photoInputGallery.addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (file) {
                const base64 = await blobToBase64(file);
                updatePhoto(base64);
            }
        });

        function updatePhoto(base64) {
            if (currentPhotoIndex === 0) {
                document.getElementById('productPhoto').src = base64;
                document.getElementById('productPhoto').style.display = 'block';
                document.getElementById('photoPlaceholder').style.display = 'none';
                currentProduct.photo = base64;
            } else {
                document.getElementById('productPhoto2').src = base64;
                document.getElementById('productPhoto2').style.display = 'block';
                document.getElementById('photoPlaceholder2').style.display = 'none';
                currentProduct.photo2 = base64;
            }
        }

        function updatePhotoArrows() {
                    document.getElementById('prevPhoto').classList.add('visible');
                    document.getElementById('nextPhoto').classList.add('visible');
                }

        function scrollPhotos(direction) {
            const gallery = document.getElementById('photoGallery');
            const slideWidth = gallery.offsetWidth;
            currentPhotoIndex = (currentPhotoIndex + direction + 2) % 2;
            gallery.scrollTo({
                left: currentPhotoIndex * slideWidth,
                behavior: 'smooth'
            });
        }

        async function updateFavoriteButton() {
            const name = document.getElementById('productName').value;
            const amount = parseFloat(document.getElementById('amountGrams').value) ||
                          parseFloat(document.getElementById('amountPieces').value) || 0;

            const check = await checkInFavorites(name, amount);
            const btn = document.getElementById('favoriteBtn');
            const badge = btn.querySelector('.favorite-badge');

            if (check.exact) {
                btn.classList.add('active');
                badge.style.display = 'none';
            } else if (check.different) {
                btn.classList.add('active');
                badge.style.display = 'inline';
            } else {
                btn.classList.remove('active');
                badge.style.display = 'none';
            }
        }

        document.getElementById('favoriteBtn').addEventListener('click', async function() {
            const productData = collectProductData();
            productData.id = generateUUID();
            await addToFavorites(productData);
            await updateFavoriteButton();
            alert('Добавлено в избранное!');
        });

        function collectProductData() {
            const isGrams = !document.getElementById('unitMode').checked;

            return {
                id: currentProduct.id,
                name: document.getElementById('productName').value,
                calories: parseFloat(document.getElementById('productCalories').value) || 0,
                protein: parseFloat(document.getElementById('productProtein').value) || 0,
                fat: parseFloat(document.getElementById('productFat').value) || 0,
                carbs: parseFloat(document.getElementById('productCarbs').value) || 0,
                sugar: parseFloat(document.getElementById('productSugar').value) || 0,
                amount: isGrams ?
                    parseFloat(document.getElementById('amountGrams').value) || 0 :
                    parseFloat(document.getElementById('amountPieces').value) || 0,
                unit: isGrams ?
                    document.getElementById('unitGrams').value :
                    document.getElementById('unitPieces').value,
                category: document.getElementById('productCategory').value,
                photo: currentProduct.photo || null,
                photo2: currentProduct.photo2 || null,
                portionNumerator: parseInt(document.getElementById('portionNumerator').value),
                portionDenominator: parseInt(document.getElementById('portionDenominator').value),
                isDish: currentProduct.isDish || false,
                ingredients: currentProduct.ingredients || []
            };
        }

        document.getElementById('saveBtn').addEventListener('click', async function() {
            const updatedProduct = collectProductData();

            updatedProduct.calories = parseFloat(updatedProduct.calories.toFixed(1));
            updatedProduct.protein = parseFloat(updatedProduct.protein.toFixed(1));
            updatedProduct.fat = parseFloat(updatedProduct.fat.toFixed(1));
            updatedProduct.carbs = parseFloat(updatedProduct.carbs.toFixed(1));
            updatedProduct.sugar = parseFloat(updatedProduct.sugar.toFixed(1));

            if (productSource === 'day') {
                await updateProductInDay(productDate, currentProduct.id, updatedProduct);
                alert('Изменения сохранены!');
                history.back();
            } else if (productSource === 'favorites') {
                await removeFromFavorites(currentProduct.id);
                await addToFavorites(updatedProduct);
                alert('Изменения сохранены!');
                history.back();
            } else if (productSource === 'dish') {
                localStorage.setItem('updatedDishIngredient', JSON.stringify(updatedProduct));
                window.location.href = 'create-dish.html';
            }
        });

        document.getElementById('closeBtn').addEventListener('click', function(e) {
            e.preventDefault();
            if (productSource === 'day') {
                window.location.href = `index.html?date=${productDate}`;
            } else if (productSource === 'favorites') {
                window.location.href = 'favorites.html';
            } else if (productSource === 'dish') {
                window.location.href = 'create-dish.html';
            } else {
                history.back();
            }
        });

        init();
    </script>
</body>
</html>
