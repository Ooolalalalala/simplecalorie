<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1A1A1A">
    <title>SimpleCalorie - –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç</title>

    <!-- –°—Ç–∏–ª–∏ -->
    <link rel="stylesheet" href="../css/variables.css">
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/add-product.css">
    
    <style>
        /* Photo Selection Popup */
        .photo-selection-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            align-items: flex-end;
            justify-content: center;
        }

        .photo-selection-popup.active {
            display: flex;
        }

        .photo-selection-content {
            background: white;
            width: 100%;
            max-width: 500px;
            border-radius: 16px 16px 0 0;
            padding: var(--spacing-md);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }

        .photo-selection-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: var(--spacing-md);
            text-align: center;
            color: var(--text-primary);
        }

        .photo-selection-buttons {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .photo-selection-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md);
            background: var(--background-secondary);
            color: var(--text-primary);
            border: none;
            border-radius: var(--radius-md);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .photo-selection-btn:active {
            background: #E5E7EB;
        }

        .photo-selection-btn svg {
            stroke: #1F2937;
        }

        .photo-selection-cancel {
            margin-top: var(--spacing-sm);
            padding: var(--spacing-md);
            background: transparent;
            color: var(--text-secondary);
            border: none;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
  </head>
  <body>
      <!-- Photo Selection Popup -->
      <div class="photo-selection-popup" id="photoSelectionPopup">
          <div class="photo-selection-content">
              <div class="photo-selection-title" data-i18n="photoSelection.title">–í—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫</div>
              <div class="photo-selection-buttons">
                  <button class="photo-selection-btn" id="selectCameraBtn">
                      <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                      </svg>
                  </button>
                  <button class="photo-selection-btn" id="selectGalleryBtn">
                      <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                      </svg>
                  </button>
              </div>
              <button class="photo-selection-cancel" id="cancelPhotoSelectionBtn" data-i18n="buttons.cancel">–û—Ç–º–µ–Ω–∞</button>
          </div>
      </div>

      <!-- Loading overlay -->
      <div class="loading-overlay" id="loadingOverlay">
          <div class="loading-spinner"></div>
          <div class="loading-text">–ê–Ω–∞–ª–∏–∑ –ò–ò...</div>
          <button class="loading-cancel" id="cancelBtn">–û—Ç–º–µ–Ω–∏—Ç—å</button>
      </div>

      <div class="app-container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <header class="app-header">
            <a href="#" id="backBtn" class="header-icon">
                 <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
            </a>
            <h1 data-i18n="addProduct.title">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç</h1>
            <div class="header-icon"></div>
        </header>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <main class="main-content">

            <!-- –°–µ–ª–µ–∫—Ç–æ—Ä —Å–ø–æ—Å–æ–±–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
            <div class="method-selector">
                <label class="method-option">
                    <input type="radio" name="addMethod" value="manual" checked>
                    <span class="method-label">
                        <span class="method-emoji">üçΩÔ∏è</span>
                        <span class="method-text" data-i18n="addProduct.methods.manual">–î–æ–±–∞–≤–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –∏–ª–∏ —Ñ–æ—Ç–æ</span>
                    </span>
                </label>

                <label class="method-option">
                    <input type="radio" name="addMethod" value="ai-photo">
                    <span class="method-label">
                        <span class="method-emoji">üì∑</span>
                        <span class="method-text" data-i18n="addProduct.methods.aiPhoto">–î–æ–±–∞–≤–∏—Ç—å —Å –ò–ò –ø–æ —Ñ–æ—Ç–æ</span>
                    </span>
                </label>

                <label class="method-option">
                    <input type="radio" name="addMethod" value="ai-text">
                    <span class="method-label">
                        <span class="method-emoji">üìù</span>
                        <span class="method-text" data-i18n="addProduct.methods.aiText">–î–æ–±–∞–≤–∏—Ç—å —Å –ò–ò –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é</span>
                    </span>
                </label>

                <label class="method-option">
                    <input type="radio" name="addMethod" value="dish">
                    <span class="method-label">
                        <span class="method-emoji">üìã</span>
                        <span class="method-text" data-i18n="addProduct.methods.table">–î–æ–±–∞–≤–∏—Ç—å –ø–æ —Ç–∞–±–ª–∏—Ü–µ</span>
                    </span>
                </label>
            </div>

            <!-- –ù–∞–∑–≤–∞–Ω–∏–µ -->
            <div class="field-group">
                <label class="field-label">
                    <span data-i18n="product.name">–ù–∞–∑–≤–∞–Ω–∏–µ</span>
                    <span class="optional" data-i18n="addProduct.optional">(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</span>
                </label>
                <input type="text" class="field-input" id="productName" data-i18n-placeholder="product.namePlaceholder">
            </div>

            <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ -->
            <div class="field-group" id="photoSection">
                <label class="field-label">
                    <span data-i18n="product.photo">–§–æ—Ç–æ</span>
                    <span class="optional" data-i18n="addProduct.optional">(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</span>
                </label>
                <div class="photo-upload">
                    <!-- –ü–µ—Ä–≤–æ–µ —Ñ–æ—Ç–æ -->
                    <input type="file" id="photoInput1Camera" accept="image/*" capture="environment" class="photo-input" style="display: none;">
                    <input type="file" id="photoInput1Gallery" accept="image/*" class="photo-input" style="display: none;">
                    
                    <div class="photo-upload-btn" id="photoBtn1">
                        <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                        <span data-i18n="product.selectPhoto">–í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ 1</span>
                    </div>
                    <div class="photo-preview" id="photoPreview1"></div>

                    <!-- –í—Ç–æ—Ä–æ–µ —Ñ–æ—Ç–æ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–µ–∂–∏–º–æ–≤ –∫—Ä–æ–º–µ "dish") -->
                    <div id="photo2Container">
                        <input type="file" id="photoInput2Camera" accept="image/*" capture="environment" class="photo-input" style="display: none;">
                        <input type="file" id="photoInput2Gallery" accept="image/*" class="photo-input" style="display: none;">
                        
                        <div class="photo-upload-btn" id="photoBtn2">
                            <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                            <span>–í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ 2</span>
                        </div>
                        <div class="photo-preview" id="photoPreview2"></div>
                    </div>
                </div>
            </div>

            <!-- –û–±—ä–µ–º -->
            <div class="field-group">
                <label class="field-label">
                    <span data-i18n="product.volume">–û–±—ä–µ–º</span>
                    <span class="optional" data-i18n="addProduct.optional">(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</span>
                </label>
                <div class="volume-input">
                    <input type="number" class="field-input" id="productVolume" placeholder="0">
                    <select class="unit-select-compact" id="volumeUnit">
                        <option value="g" selected data-i18n="units.g">–≥</option>
                        <option value="ml" data-i18n="units.ml">–º–ª</option>
                    </select>
                </div>
            </div>

            <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
            <div class="field-group">
                <label class="field-label">
                    <span data-i18n="product.comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è –ò–ò</span>
                    <span class="optional" data-i18n="addProduct.optional">(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</span>
                </label>
                <textarea class="field-textarea" id="productComment" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –ò–ò..." rows="3"></textarea>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
            <button class="btn btn-primary add-product-btn" id="addBtn" data-i18n="buttons.add">–î–æ–±–∞–≤–∏—Ç—å</button>

        </main>
    </div>

    <!-- –°–∫—Ä–∏–ø—Ç—ã -->
    <script src="../js/utils.js"></script>
    <script src="../js/storage.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/i18n.js"></script>

    <script>
        let photo1Base64 = null;
        let photo2Base64 = null;
        let currentPhotoTarget = null;

        async function init() {
            await initDB();
            await initI18n();
            updatePhotoVisibility();
        }

        document.getElementById('backBtn').addEventListener('click', function(e) {
            e.preventDefault();
            const params = new URLSearchParams(window.location.search);
            const date = params.get('date') || getCurrentDate();
            window.location.href = `index.html?date=${date}`;
        });

        const photoSelectionPopup = document.getElementById('photoSelectionPopup');
        const selectCameraBtn = document.getElementById('selectCameraBtn');
        const selectGalleryBtn = document.getElementById('selectGalleryBtn');
        const cancelPhotoSelectionBtn = document.getElementById('cancelPhotoSelectionBtn');

        document.getElementById('photoBtn1').addEventListener('click', function() {
            currentPhotoTarget = 'photo1';
            photoSelectionPopup.classList.add('active');
        });

        document.getElementById('photoBtn2').addEventListener('click', function() {
            currentPhotoTarget = 'photo2';
            photoSelectionPopup.classList.add('active');
        });

        function closePhotoPopup() {
            photoSelectionPopup.classList.remove('active');
        }

        cancelPhotoSelectionBtn.addEventListener('click', closePhotoPopup);

        photoSelectionPopup.addEventListener('click', function(e) {
            if (e.target === photoSelectionPopup) {
                closePhotoPopup();
            }
        });

        selectCameraBtn.addEventListener('click', function() {
            if (currentPhotoTarget === 'photo1') {
                document.getElementById('photoInput1Camera').click();
            } else {
                document.getElementById('photoInput2Camera').click();
            }
            closePhotoPopup();
        });

        selectGalleryBtn.addEventListener('click', function() {
            if (currentPhotoTarget === 'photo1') {
                document.getElementById('photoInput1Gallery').click();
            } else {
                document.getElementById('photoInput2Gallery').click();
            }
            closePhotoPopup();
        });

        document.getElementById('photoInput1Camera').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (file) {
                photo1Base64 = await blobToBase64(file);
                const btn = document.getElementById('photoBtn1');
                btn.innerHTML = `<img src="${photo1Base64}" alt="Preview" style="width: 100%; height: 100%; object-fit: cover; border-radius: var(--radius-lg);">`;
            }
        });

        document.getElementById('photoInput1Gallery').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (file) {
                photo1Base64 = await blobToBase64(file);
                const btn = document.getElementById('photoBtn1');
                btn.innerHTML = `<img src="${photo1Base64}" alt="Preview" style="width: 100%; height: 100%; object-fit: cover; border-radius: var(--radius-lg);">`;
            }
        });

        document.getElementById('photoInput2Camera').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (file) {
                photo2Base64 = await blobToBase64(file);
                const btn = document.getElementById('photoBtn2');
                btn.innerHTML = `<img src="${photo2Base64}" alt="Preview" style="width: 100%; height: 100%; object-fit: cover; border-radius: var(--radius-lg);">`;
            }
        });

        document.getElementById('photoInput2Gallery').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (file) {
                photo2Base64 = await blobToBase64(file);
                const btn = document.getElementById('photoBtn2');
                btn.innerHTML = `<img src="${photo2Base64}" alt="Preview" style="width: 100%; height: 100%; object-fit: cover; border-radius: var(--radius-lg);">`;
            }
        });

        function updatePhotoVisibility() {
            const method = document.querySelector('input[name="addMethod"]:checked').value;
            const photo2Container = document.getElementById('photo2Container');
            if (method === 'dish') {
                photo2Container.style.display = 'none';
            } else {
                photo2Container.style.display = 'block';
            }
        }

        document.querySelectorAll('input[name="addMethod"]').forEach(radio => {
            radio.addEventListener('change', updatePhotoVisibility);
        });

        document.getElementById('addBtn').addEventListener('click', async function() {
            const method = document.querySelector('input[name="addMethod"]:checked').value;
            const name = document.getElementById('productName').value.trim();
            const volume = parseFloat(document.getElementById('productVolume').value) || null;
            const comment = document.getElementById('productComment').value.trim();

            if (method === 'ai-photo' || method === 'ai-text' || method === 'dish') {
                if (!checkApiKey()) {
                    alert(t('messages.apiKeyMissing'));
                    return;
                }
            }

            if (method === 'ai-photo' && !photo1Base64) {
                alert('–î–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø–æ —Ñ–æ—Ç–æ –Ω—É–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —Ñ–æ—Ç–æ!');
                return;
            }

            if (method === 'ai-text' && !name) {
                alert('–î–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ!');
                return;
            }

            if (method === 'dish' && !photo1Base64) {
                alert('–î–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç–∞–±–ª–∏—Ü—ã –Ω—É–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ!');
                return;
            }

            const params = new URLSearchParams(window.location.search);
            const target = params.get('target');
            const currentDate = target === 'dish' ? null : getCurrentDate();

            try {
                if (method === 'manual') {
                    const product = {
                        id: generateUUID(),
                        name: name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',
                        calories: 0,
                        protein: 0,
                        fat: 0,
                        carbs: 0,
                        sugar: 0,
                        amount: volume || 0,
                        unit: document.getElementById('volumeUnit').value,
                        category: '',
                        photo: photo1Base64 || null,
                        photo2: photo2Base64 || null,
                        loading: false
                    };

                    if (target === 'dish') {
                        localStorage.setItem('newDishIngredient', JSON.stringify(product));
                        window.location.href = 'create-dish.html';
                    } else {
                        await addProductToDay(currentDate, product);
                        
                        photo1Base64 = null;
                        photo2Base64 = null;
                        document.getElementById('photoInput1Camera').value = '';
                        document.getElementById('photoInput1Gallery').value = '';
                        document.getElementById('photoInput2Camera').value = '';
                        document.getElementById('photoInput2Gallery').value = '';
                        
                        alert('–ü—Ä–æ–¥—É–∫—Ç –¥–æ–±–∞–≤–ª–µ–Ω!');
                        window.location.href = 'index.html';
                    }
                } else {
                    const loadingProduct = createLoadingProduct(name || '–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é...');
                    loadingProduct.photo = photo1Base64;
                    loadingProduct.photo2 = photo2Base64;

                    if (target !== 'dish') {
                        await addProductToDay(currentDate, loadingProduct);
                    }

                    document.getElementById('loadingOverlay').classList.add('active');
                    const unit = document.getElementById('volumeUnit').value;

                    await processAI(method, name, volume, unit, comment, loadingProduct.id, currentDate, target);

                    document.getElementById('loadingOverlay').classList.remove('active');

                    photo1Base64 = null;
                    photo2Base64 = null;
                    document.getElementById('photoInput1Camera').value = '';
                    document.getElementById('photoInput1Gallery').value = '';
                    document.getElementById('photoInput2Camera').value = '';
                    document.getElementById('photoInput2Gallery').value = '';
                    document.getElementById('productName').value = '';
                    document.getElementById('productVolume').value = '';
                    document.getElementById('productComment').value = '';

                    if (target === 'dish') {
                        window.location.href = 'create-dish.html';
                    } else {
                        window.location.href = 'index.html';
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è:', error);
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        });

        async function processAI(method, name, volume, unit, comment, productId, date, target) {
            try {
                let result;

                if (method === 'dish') {
                    result = await analyzeTable(photo1Base64, null, name, volume, unit, comment);
                } else {
                    const photos = [photo1Base64, photo2Base64].filter(Boolean);
                    result = await analyzeProduct(photos, name, volume, unit, comment);
                }

                result.photo = photo1Base64;
                result.loading = false;

                if (target === 'dish') {
                    localStorage.setItem('newDishIngredient', JSON.stringify(result));
                } else {
                    await updateProductInDay(date, productId, result);
                }

                console.log('–ò–ò –æ–±—Ä–∞–±–æ—Ç–∞–ª –ø—Ä–æ–¥—É–∫—Ç:', result);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ò–ò:', error);

                if (target !== 'dish') {
                    await deleteProductFromDay(date, productId);
                }
            }
        }

        document.getElementById('cancelBtn').addEventListener('click', function() {
            document.getElementById('loadingOverlay').classList.remove('active');
            window.location.href = 'index.html';
        });

        init();
    </script>
</body>
</html>
