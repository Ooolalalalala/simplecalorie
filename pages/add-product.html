<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1A1A1A">
    <title>SimpleCalorie - –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç</title>

    <!-- –°—Ç–∏–ª–∏ -->
    <link rel="stylesheet" href="../css/variables.css">
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/add-product.css">
  </head>
  <body>
      <!-- Loading overlay -->
      <div class="loading-overlay" id="loadingOverlay">
          <div class="loading-spinner"></div>
          <div class="loading-text">–ê–Ω–∞–ª–∏–∑ –ò–ò...</div>
          <button class="loading-cancel" id="cancelBtn">–û—Ç–º–µ–Ω–∏—Ç—å</button>
      </div>

      <div class="app-container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <header class="app-header">
            <a href="javascript:history.back()" class="header-icon">
                <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
            </a>
            <h1 data-i18n="addProduct.title">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç</h1>
            <div class="header-icon"></div>
        </header>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <main class="main-content">

            <!-- –°–µ–ª–µ–∫—Ç–æ—Ä —Å–ø–æ—Å–æ–±–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
            <div class="method-selector">
                <label class="method-option">
                    <input type="radio" name="addMethod" value="manual" checked>
                    <span class="method-label">
                        <span class="method-emoji">üçΩÔ∏è</span>
                        <span class="method-text" data-i18n="addProduct.methods.manual">–î–æ–±–∞–≤–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –∏–ª–∏ —Ñ–æ—Ç–æ</span>
                    </span>
                </label>

                <label class="method-option">
                    <input type="radio" name="addMethod" value="ai-photo">
                    <span class="method-label">
                        <span class="method-emoji">üì∑</span>
                        <span class="method-text" data-i18n="addProduct.methods.aiPhoto">–î–æ–±–∞–≤–∏—Ç—å —Å –ò–ò –ø–æ —Ñ–æ—Ç–æ</span>
                    </span>
                </label>

                <label class="method-option">
                    <input type="radio" name="addMethod" value="ai-text">
                    <span class="method-label">
                        <span class="method-emoji">üìù</span>
                        <span class="method-text" data-i18n="addProduct.methods.aiText">–î–æ–±–∞–≤–∏—Ç—å —Å –ò–ò –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é</span>
                    </span>
                </label>

                <label class="method-option">
                    <input type="radio" name="addMethod" value="dish">
                    <span class="method-label">
                        <span class="method-emoji">üìã</span>
                        <span class="method-text" data-i18n="addProduct.methods.table">–î–æ–±–∞–≤–∏—Ç—å –ø–æ —Ç–∞–±–ª–∏—Ü–µ</span>
                    </span>
                </label>
            </div>

            <!-- –ù–∞–∑–≤–∞–Ω–∏–µ -->
            <div class="field-group">
                <label class="field-label">
                    <span data-i18n="product.name">–ù–∞–∑–≤–∞–Ω–∏–µ</span>
                    <span class="optional" data-i18n="addProduct.optional">(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</span>
                </label>
                <input type="text" class="field-input" id="productName" data-i18n-placeholder="product.namePlaceholder">
            </div>

            <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ -->
            <div class="field-group" id="photoSection">
                <label class="field-label">
                    <span data-i18n="product.photo">–§–æ—Ç–æ</span>
                    <span class="optional" data-i18n="addProduct.optional">(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</span>
                </label>
                <div class="photo-upload">
                    <!-- –ü–µ—Ä–≤–æ–µ —Ñ–æ—Ç–æ -->
                    <input type="file" id="photoInput1" accept="image/*" class="photo-input">
                    <label for="photoInput1" class="photo-upload-btn">
                        <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                        <span data-i18n="product.selectPhoto">–í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ 1</span>
                    </label>
                    <div class="photo-preview" id="photoPreview1"></div>

                    <!-- –í—Ç–æ—Ä–æ–µ —Ñ–æ—Ç–æ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–µ–∂–∏–º–æ–≤ –∫—Ä–æ–º–µ "dish") -->
                    <div id="photo2Container">
                        <input type="file" id="photoInput2" accept="image/*" class="photo-input">
                        <label for="photoInput2" class="photo-upload-btn">
                            <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                            <span>–í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ 2</span>
                        </label>
                        <div class="photo-preview" id="photoPreview2"></div>
                    </div>
                </div>
            </div>

            <!-- –û–±—ä–µ–º -->
            <div class="field-group">
                <label class="field-label">
                    <span data-i18n="product.volume">–û–±—ä–µ–º</span>
                    <span class="optional" data-i18n="addProduct.optional">(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</span>
                </label>
                <div class="volume-input">
                    <input type="number" class="field-input" id="productVolume" placeholder="0">
                    <select class="unit-select-compact" id="volumeUnit">
                        <option value="g" selected data-i18n="units.g">–≥</option>
                        <option value="ml" data-i18n="units.ml">–º–ª</option>
                    </select>
                </div>
            </div>

            <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
            <div class="field-group">
                <label class="field-label">
                    <span data-i18n="product.comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è –ò–ò</span>
                    <span class="optional" data-i18n="addProduct.optional">(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</span>
                </label>
                <textarea class="field-textarea" id="productComment" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –ò–ò..." rows="3"></textarea>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
            <button class="btn btn-primary add-product-btn" id="addBtn" data-i18n="buttons.add">–î–æ–±–∞–≤–∏—Ç—å</button>

        </main>
    </div>

    <!-- –°–∫—Ä–∏–ø—Ç—ã -->
    <script src="../js/utils.js"></script>
    <script src="../js/storage.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/i18n.js"></script>

    <script>
        let photo1Base64 = null;
        let photo2Base64 = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        async function init() {
            await initDB();
            await initI18n();

            // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –≤—Ç–æ—Ä–æ–µ —Ñ–æ—Ç–æ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
            updatePhotoVisibility();
        }

        // –ü—Ä–µ–≤—å—é —Ñ–æ—Ç–æ 1
                document.getElementById('photoInput1').addEventListener('change', async function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        photo1Base64 = await blobToBase64(file);
                        const label = document.querySelector('label[for="photoInput1"]');
                        label.innerHTML = `<img src="${photo1Base64}" alt="Preview" style="width: 100%; height: 100%; object-fit: cover; border-radius: var(--radius-lg);">`;
                    }
                });
                // –ü—Ä–µ–≤—å—é —Ñ–æ—Ç–æ 2
                        document.getElementById('photoInput2').addEventListener('change', async function(e) {
                            const file = e.target.files[0];
                            if (file) {
                                photo2Base64 = await blobToBase64(file);
                                const label = document.querySelector('label[for="photoInput2"]');
                                label.innerHTML = `<img src="${photo2Base64}" alt="Preview" style="width: 100%; height: 100%; object-fit: cover; border-radius: var(--radius-lg);">`;
                            }
                        });

        // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –≤—Ç–æ—Ä–æ–µ —Ñ–æ—Ç–æ
        function updatePhotoVisibility() {
            const method = document.querySelector('input[name="addMethod"]:checked').value;
            const photo2Container = document.getElementById('photo2Container');

            if (method === 'dish') {
                // –†–µ–∂–∏–º —Ç–∞–±–ª–∏—Ü—ã - —Ç–æ–ª—å–∫–æ 1 —Ñ–æ—Ç–æ
                photo2Container.style.display = 'none';
            } else {
                // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∂–∏–º—ã - –¥–æ 2 —Ñ–æ—Ç–æ
                photo2Container.style.display = 'block';
            }
        }

        // –°–ª—É—à–∞–µ–º —Å–º–µ–Ω—É –º–µ—Ç–æ–¥–∞
        document.querySelectorAll('input[name="addMethod"]').forEach(radio => {
            radio.addEventListener('change', updatePhotoVisibility);
        });

        // –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–∏—Ç—å
        document.getElementById('addBtn').addEventListener('click', async function() {
            const method = document.querySelector('input[name="addMethod"]:checked').value;
            const name = document.getElementById('productName').value.trim();
            const volume = parseFloat(document.getElementById('productVolume').value) || null;
            const comment = document.getElementById('productComment').value.trim();

            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (method === 'ai-photo' || method === 'ai-text' || method === 'dish') {
                if (!checkApiKey()) {
                    alert(t('messages.apiKeyMissing'));
                    return;
                }
            }

            if (method === 'ai-photo' && !photo1Base64) {
                alert('–î–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø–æ —Ñ–æ—Ç–æ –Ω—É–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —Ñ–æ—Ç–æ!');
                return;
            }

            if (method === 'ai-text' && !name) {
                alert('–î–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ!');
                return;
            }

            if (method === 'dish' && !photo1Base64) {
                alert('–î–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç–∞–±–ª–∏—Ü—ã –Ω—É–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ!');
                return;
            }

            // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
            const params = new URLSearchParams(window.location.search);
            const target = params.get('target'); // 'dish' –µ—Å–ª–∏ –¥–æ–±–∞–≤–ª—è–µ–º –≤ –±–ª—é–¥–æ
            const currentDate = target === 'dish' ? null : getCurrentDate();

            try {
                if (method === 'manual') {
                    // –†—É—á–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ
                    const product = {
                        id: generateUUID(),
                        name: name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',
                        calories: 0,
                        protein: 0,
                        fat: 0,
                        carbs: 0,
                        sugar: 0,
                        amount: volume || 0,
                        unit: document.getElementById('volumeUnit').value,
                        category: '',
                        photo: photo1Base64 || null,
                       photo2: photo2Base64 || null,
                       loading: false
                    };

                    if (target === 'dish') {
                        // –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –±–ª—é–¥–æ —Å –ø—Ä–æ–¥—É–∫—Ç–æ–º
                        localStorage.setItem('newDishIngredient', JSON.stringify(product));
                        window.location.href = 'create-dish.html';
                    } else {
                        // –î–æ–±–∞–≤–∏—Ç—å –≤ –¥–µ–Ω—å
                        await addProductToDay(currentDate, product);
                        alert('–ü—Ä–æ–¥—É–∫—Ç –¥–æ–±–∞–≤–ª–µ–Ω!');
                        window.location.href = 'index.html';
                    }
                } else {
                    // –° –ò–ò - —Å–æ–∑–¥–∞—ë–º loading –ø—Ä–æ–¥—É–∫—Ç
                    const loadingProduct = createLoadingProduct(name || '–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é...');
                    loadingProduct.photo = photo1Base64;
                    loadingProduct.photo2 = photo2Base64;

                    if (target !== 'dish') {
                                            await addProductToDay(currentDate, loadingProduct);
                                          }

                                  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º loading overlay
                                  document.getElementById('loadingOverlay').classList.add('active');

                                  // –ü–æ–ª—É—á–∞–µ–º unit –∏–∑ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞
                                  const unit = document.getElementById('volumeUnit').value;

                                  // –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ò–ò –î–û –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                          await processAI(method, name, volume, unit, comment, loadingProduct.id, currentDate, target);

                          // –°–∫—Ä—ã–≤–∞–µ–º loading overlay
                          document.getElementById('loadingOverlay').classList.remove('active');

                          // –ü–µ—Ä–µ—Ö–æ–¥ –æ–±—Ä–∞—Ç–Ω–æ –ü–û–°–õ–ï –æ–±—Ä–∞–±–æ—Ç–∫–∏
                                        if (target === 'dish') {
                                            window.location.href = 'create-dish.html';
                                        } else {
                                            window.location.href = 'index.html';
                                        }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è:', error);
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        });

        // –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ò–ò
      async function processAI(method, name, volume, unit, comment, productId, date, target) {
            try {
                let result;

                if (method === 'dish') {
                    // –ê–Ω–∞–ª–∏–∑ —Ç–∞–±–ª–∏—Ü—ã
                  result = await analyzeTable(photo1Base64, null, name, volume, unit, comment);
                } else {
                    // –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–¥—É–∫—Ç–∞ (–ø–æ —Ñ–æ—Ç–æ, —Ç–µ–∫—Å—Ç—É, –∏–ª–∏ –æ–±–∞)
                    const photos = [photo1Base64, photo2Base64].filter(Boolean);
                    result = await analyzeProduct(photos, name, volume, unit, comment);
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–¥—É–∫—Ç
                result.photo = photo1Base64;
                result.loading = false;

                if (target === 'dish') {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –±–ª—é–¥–∞
                    localStorage.setItem('newDishIngredient', JSON.stringify(result));
                } else {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤ –¥–Ω–µ
                    await updateProductInDay(date, productId, result);
                }

                console.log('–ò–ò –æ–±—Ä–∞–±–æ—Ç–∞–ª –ø—Ä–æ–¥—É–∫—Ç:', result);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ò–ò:', error);

                if (target !== 'dish') {
                    // –£–¥–∞–ª—è–µ–º loading –ø—Ä–æ–¥—É–∫—Ç
                    await deleteProductFromDay(date, productId);
                }
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ–Ω—ã
          document.getElementById('cancelBtn').addEventListener('click', function() {
              document.getElementById('loadingOverlay').classList.remove('active');
              window.location.href = 'index.html';
          });

          // –ó–∞–ø—É—Å–∫
          init();
    </script>
</body>
</html>
