<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1A1A1A">
    <title>SimpleCalorie</title>
    <link rel="manifest" href="../manifest.json">
    <!-- –°—Ç–∏–ª–∏ -->
    <link rel="stylesheet" href="../css/variables.css">
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/components.css">
</head>
<body>
    <div class="app-container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <header class="app-header">
            <a href="favorites.html" class="header-icon">
                <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                </svg>
            </a>
            <h1 data-i18n="app.name">SimpleCalorie</h1>
            <a href="profile.html" class="header-icon">
                <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
            </a>
        </header>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <main class="main-content">
            <!-- –í–æ–¥–∞ + –ö–∞–ª–µ–Ω–¥–∞—Ä—å -->
            <div class="calendar-section">
                <div class="top-row">
                    <!-- –í–æ–¥–∞ —Å–ª–µ–≤–∞ -->
                    <div class="water-indicator">
                        <svg class="water-icon" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2.69l5.66 5.66a8 8 0 11-11.31 0z"/>
                        </svg>
                        <span class="water-amount" id="waterAmount">0–ª</span>
                    </div>

                    <!-- –ë–ª–æ–∫ –∫–∞–ª–µ–Ω–¥–∞—Ä—è —Å–ø—Ä–∞–≤–∞ -->
                    <div class="calendar-block">
                        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è -->
                        <div class="calendar-nav">
                            <button class="btn-today" id="todayBtn" data-i18n="main.today">–°–µ–≥–æ–¥–Ω—è</button>
                            <input type="date" class="date-picker" id="datePicker">
                        </div>

                        <!-- –ü–æ–ª–æ—Å–∞ –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏ -->
                        <div class="days-bar" id="daysBar">
                            <!-- –î–Ω–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ü–∞–Ω–µ–ª—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ -->
            <div class="indicators-panel">
                <div class="indicators-container">
                    <!-- –ö–∞–ª–æ—Ä–∏–∏ -->
                    <div class="calories-indicator">
                        <div class="calories-circle">
                          <svg class="calories-svg" width="120" height="120" viewBox="0 0 120 120">
                                                          <circle class="calories-bg" cx="60" cy="60" r="52"
                                                                  stroke-width="8" fill="none"
                                                                  stroke="#E5E7EB"/>
                                                          <circle class="calories-progress" id="caloriesProgress" cx="60" cy="60" r="52"
                                                                  stroke-width="8" fill="none"
                                                                  stroke-dasharray="0 326.7"
                                                                  stroke-linecap="butt"
                                                                  transform="rotate(-90 60 60)"/>
                          </svg>
                            <div class="calories-value">
                                <span class="calories-number" id="caloriesNumber">2000</span>
                                <span class="calories-label" data-i18n="main.remaining">–æ—Å—Ç–∞–ª–æ—Å—å</span>
                            </div>
                        </div>
                    </div>

                    <!-- –ë–ñ–£ + –°–∞—Ö–∞—Ä -->
                    <div class="nutrients-indicators">
                        <div class="nutrient-bar">
                            <div class="nutrient-header">
                                <span class="nutrient-name" data-i18n="nutrients.protein">–ë–µ–ª–∫–∏</span>
                                <span class="nutrient-values" id="proteinValues">0/0–≥</span>
                            </div>
                            <div class="nutrient-progress">
                                <div class="nutrient-fill protein" id="proteinFill" style="width: 0%;"></div>
                            </div>
                        </div>

                        <div class="nutrient-bar">
                            <div class="nutrient-header">
                                <span class="nutrient-name" data-i18n="nutrients.fat">–ñ–∏—Ä—ã</span>
                                <span class="nutrient-values" id="fatValues">0/0–≥</span>
                            </div>
                            <div class="nutrient-progress">
                                <div class="nutrient-fill fat" id="fatFill" style="width: 0%;"></div>
                            </div>
                        </div>

                        <div class="nutrient-bar">
                            <div class="nutrient-header">
                                <span class="nutrient-name" data-i18n="nutrients.carbs">–£–≥–ª–µ–≤–æ–¥—ã</span>
                                <span class="nutrient-values" id="carbsValues">0/0–≥</span>
                            </div>
                            <div class="nutrient-progress">
                                <div class="nutrient-fill carbs" id="carbsFill" style="width: 0%;"></div>
                            </div>
                        </div>

                        <div class="nutrient-bar">
                            <div class="nutrient-header">
                                <span class="nutrient-name" data-i18n="nutrients.sugar">–°–∞—Ö–∞—Ä</span>
                                <span class="nutrient-values" id="sugarValues">0/0–≥</span>
                            </div>
                            <div class="nutrient-progress">
                                <div class="nutrient-fill sugar" id="sugarFill" style="width: 0%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ò—Å—Ç–æ—Ä–∏—è -->
            <section class="history-section">
                <h2 class="history-header">
                    <span data-i18n="main.history">–ò—Å—Ç–æ—Ä–∏—è</span>
                    <span class="history-average" id="historyAverage"></span>
                </h2>

                <div class="meals-list" id="mealsList">
                    <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è JS -->
                </div>
            </section>
        </main>

        <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
        <button class="fab" id="addBtn">+</button>

        <!-- Bottom Sheet –º–µ–Ω—é –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
        <div class="bottom-sheet" id="addMenu">
            <div class="bottom-sheet-overlay"></div>
            <div class="bottom-sheet-content">
                <div class="bottom-sheet-header">
                    <h3 data-i18n="main.addMenu.title">–î–æ–±–∞–≤–∏—Ç—å</h3>
                    <button class="bottom-sheet-close">‚úï</button>
                </div>
                <div class="bottom-sheet-menu">
                    <a href="add-product.html" class="menu-item">
                        <div class="menu-icon menu-icon-food">üçΩÔ∏è</div>
                        <span data-i18n="main.addMenu.product">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç</span>
                    </a>
                    <a href="water.html" class="menu-item">
                        <div class="menu-icon menu-icon-water">üíß</div>
                        <span data-i18n="main.addMenu.water">–î–æ–±–∞–≤–∏—Ç—å –≤–æ–¥—É</span>
                    </a>
                    <a href="create-dish.html" class="menu-item">
                        <div class="menu-icon">üç≤</div>
                        <span data-i18n="main.addMenu.dish">–î–æ–±–∞–≤–∏—Ç—å –±–ª—é–¥–æ</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- –°–∫—Ä–∏–ø—Ç—ã -->
    <script src="../js/utils.js"></script>
    <script src="../js/storage.js"></script>
    <script src="../js/i18n.js"></script>

    <!-- JavaScript -->
    <script>
        let currentDate = null;
        let currentDayData = null;
        let currentGoal = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        async function init() {
            await initDB();
            await initI18n();

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∞—Ç—É
            const urlDate = getDateFromUrl();
            currentDate = urlDate ? urlDate : getCurrentDate();

            // –ï—Å–ª–∏ –¥–∞—Ç–∞ –Ω–µ –∏–∑ URL - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤ URL
            if (!urlDate) {
                setDateToUrl(currentDate);
            }

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            await loadDayData();
            await loadGoal();

            // –°—Ç—Ä–æ–∏–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            buildCalendar();
            updateIndicators();
            renderMeals();
            updateHistoryAverage();

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä –¥–∞—Ç—ã
            document.getElementById('datePicker').value = currentDate;
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–Ω—è
        async function loadDayData() {
            currentDayData = await getDayData(currentDate);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ü–µ–ª–∏
                async function loadGoal() {
                    currentGoal = await getGoalForDate(currentDate);

                    if (!currentGoal) {
                        currentGoal = {
                            calories: 2000,
                            protein: 100,
                            fat: 70,
                            carbs: 250,
                            sugar: 50,
                            water: 2000
                        };
                    }
                }

        // –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        function buildCalendar() {
            const week = getWeekDates(currentDate);
            const daysBar = document.getElementById('daysBar');
            const today = getCurrentDate();

            daysBar.innerHTML = '';

            week.forEach(date => {
                const dayName = getDayName(date, getCurrentLanguage());
                const dayNumber = new Date(date).getDate();

                const dayItem = document.createElement('a');
                dayItem.href = `index.html?date=${date}`;
                dayItem.className = 'day-item';

                if (date === today) {
                    dayItem.classList.add('today');
                }
                if (date === currentDate) {
                    dayItem.classList.add('active');
                }

                dayItem.innerHTML = `
                    <span class="day-label">${dayName}</span>
                    <span class="day-date">${dayNumber}</span>
                `;

                dayItem.addEventListener('click', (e) => {
                    e.preventDefault();
                    currentDate = date;
                    setDateToUrl(date);
                    location.reload();
                });

                daysBar.appendChild(dayItem);
            });
        }

        // –ö–Ω–æ–ø–∫–∞ "–°–µ–≥–æ–¥–Ω—è"
        document.getElementById('todayBtn').addEventListener('click', () => {
            currentDate = getCurrentDate();
            setDateToUrl(currentDate);
            location.reload();
        });

        // –°–µ–ª–µ–∫—Ç–æ—Ä –¥–∞—Ç—ã
        document.getElementById('datePicker').addEventListener('change', function() {
            currentDate = this.value;
            setDateToUrl(currentDate);
            location.reload();
        });

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
        function updateIndicators() {
            const totals = currentDayData.products.reduce((sum, p) => ({
                calories: sum.calories + (p.calories || 0),
                protein: sum.protein + (p.protein || 0),
                fat: sum.fat + (p.fat || 0),
                carbs: sum.carbs + (p.carbs || 0),
                sugar: sum.sugar + (p.sugar || 0)
            }), { calories: 0, protein: 0, fat: 0, carbs: 0, sugar: 0 });

            // –ö–∞–ª–æ—Ä–∏–∏
            const caloriesRemaining = currentGoal.calories - totals.calories;
            const caloriesPercent = Math.min((totals.calories / currentGoal.calories) * 100, 100);
            const circumference = 2 * Math.PI * 52; // 326.7
            const filledLength = (circumference * caloriesPercent / 100).toFixed(1);

            document.getElementById('caloriesProgress').setAttribute('stroke-dasharray', `${filledLength} ${circumference}`);

              const caloriesLabel = document.querySelector('.calories-label');

              if (totals.calories > currentGoal.calories) {
                  document.getElementById('caloriesProgress').style.stroke = '#EF4444';
                  document.getElementById('caloriesNumber').style.color = '#EF4444';
                  document.getElementById('caloriesNumber').textContent = roundCaloriesUp(totals.calories - currentGoal.calories);
                  caloriesLabel.style.display = 'none';
              } else {
                  document.getElementById('caloriesProgress').style.stroke = '#1A1A1A';
                  document.getElementById('caloriesNumber').style.color = '#1A1A1A';
                  document.getElementById('caloriesNumber').textContent = roundCaloriesUp(Math.max(0, caloriesRemaining));
                  caloriesLabel.style.display = 'block';
              }

            // –ë–ñ–£
            updateNutrient('protein', totals.protein, currentGoal.protein);
            updateNutrient('fat', totals.fat, currentGoal.fat);
            updateNutrient('carbs', totals.carbs, currentGoal.carbs);
            updateNutrient('sugar', totals.sugar, currentGoal.sugar);

            // –í–æ–¥–∞
            const waterLiters = (currentDayData.waterIntake / 1000).toFixed(1);
            document.getElementById('waterAmount').textContent = `${waterLiters}–ª`;
        }

        function updateNutrient(name, current, goal) {
            const percent = Math.min((current / goal) * 100, 100);
            document.getElementById(`${name}Values`).textContent = `${Math.round(current)}/${Math.round(goal)}–≥`;
            document.getElementById(`${name}Fill`).style.width = `${percent}%`;

            if (current > goal) {
                document.getElementById(`${name}Values`).style.color = '#EF4444';
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–ª—é–¥
        function renderMeals() {
            const mealsList = document.getElementById('mealsList');

            if (currentDayData.products.length === 0) {
                mealsList.innerHTML = '<p style="text-align: center; color: #6B7280; padding: 2rem;">–ù–µ—Ç –ø—Ä–æ–¥—É–∫—Ç–æ–≤</p>';
                return;
            }

            mealsList.innerHTML = '';

            currentDayData.products.forEach(product => {
                const card = document.createElement('a');
                card.href = `product-card.html?productId=${product.id}&date=${currentDate}&source=day`;
                card.className = 'meal-card';

                const photoSrc = product.photo || '';
                  const imgHtml = photoSrc ?
                      `<img src="${photoSrc}" alt="${product.name}" class="meal-image">` :
                      `<div class="meal-image meal-image-placeholder">
                          <svg width="48" height="48" fill="#9CA3AF" viewBox="0 0 24 24">
                              <path d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                              <circle cx="12" cy="13" r="3" fill="#E5E7EB"/>
                          </svg>
                      </div>`;

                card.innerHTML = `
                    ${imgHtml}
                    <div class="meal-info">
                        <h3 class="meal-name">${product.name}</h3>
                        <p class="meal-calories">${roundCaloriesUp(product.calories || 0)} –∫–∫–∞–ª ¬∑ ${Math.round(product.amount || 0)}${product.unit || '–≥'}</p>
                        <div class="meal-nutrients">
                            <span class="nutrient-badge">
                                <span class="nutrient-dot protein"></span>
                                ${Math.round(product.protein || 0)}–≥
                            </span>
                            <span class="nutrient-badge">
                                <span class="nutrient-dot fat"></span>
                                ${Math.round(product.fat || 0)}–≥
                            </span>
                            <span class="nutrient-badge">
                                <span class="nutrient-dot carbs"></span>
                                ${Math.round(product.carbs || 0)}–≥
                            </span>
                        </div>
                    </div>
                    <div class="meal-delete" data-id="${product.id}">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </div>
                `;

                mealsList.appendChild(card);
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
            document.querySelectorAll('.meal-delete').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    if (confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç?')) {
                        await deleteProductFromDay(currentDate, btn.dataset.id);
                        await loadDayData();
                        updateIndicators();
                        renderMeals();
                    }
                });
            });
        }

        // –°—Ä–µ–¥–Ω–µ–µ –∑–∞ 7 –¥–Ω–µ–π
        async function updateHistoryAverage() {
            const today = new Date(currentDate);
            let totalCalories = 0;
            let count = 0;

            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const dateStr = formatDate(date);

                const dayData = await getDayData(dateStr);
                const dayCalories = dayData.products.reduce((sum, p) => sum + (p.calories || 0), 0);

                if (dayCalories > 0) {
                    totalCalories += dayCalories;
                    count++;
                }
            }

            if (count > 0) {
                const average = Math.round(totalCalories / count);
                document.getElementById('historyAverage').textContent = `(${t('main.average')}: ${average})`;
            }
        }

        // Bottom Sheet
        const addBtn = document.getElementById('addBtn');
        const addMenu = document.getElementById('addMenu');
        const closeBtn = document.querySelector('.bottom-sheet-close');
        const overlay = document.querySelector('.bottom-sheet-overlay');

        addBtn.addEventListener('click', () => {
            addMenu.classList.add('active');
        });

        closeBtn.addEventListener('click', () => {
            addMenu.classList.remove('active');
        });

        overlay.addEventListener('click', () => {
            addMenu.classList.remove('active');
        });

        // –ó–∞–ø—É—Å–∫
        init();
    </script>
</body>
</html>
